<DOC>
<DOCNO>EP-0645046</DOCNO> 
<TEXT>
<INVENTION-TITLE>
DATA WRITING TO NON-VOLATILE MEMORY
</INVENTION-TITLE>
<CLASSIFICATIONS>G06K1900	G06F1114	G06K1900	G06Q4000	G06Q4000	G07F708	G06F1216	G11C1610	G06F706	G07F708	G06F1216	G11C1700	G07F710	G11C1606	G07F710	G11C1700	G06F710	G06F1114	G11C1606	</CLASSIFICATIONS>
<CLASSIFICATIONS-THIRD>G06K	G06F	G06K	G06Q	G06Q	G07F	G06F	G11C	G06F	G07F	G06F	G11C	G07F	G11C	G07F	G11C	G06F	G06F	G11C	</CLASSIFICATIONS-THIRD>
<CLASSIFICATIONS-FOURTH>G06K19	G06F11	G06K19	G06Q40	G06Q40	G07F7	G06F12	G11C16	G06F7	G07F7	G06F12	G11C17	G07F7	G11C16	G07F7	G11C17	G06F7	G06F11	G11C16	</CLASSIFICATIONS-FOURTH>
<ABSTRACT>
A method of writing data to non-volatile memory such as electrically erasable programmable read only memory (EEPROM) in a smart card provides a write status region of EEPROM which is examined on each reset of the card. If the preceding write operation was unsuccessful, perhaps because of deliberate manipulation of the card, a recovery procedure is implemented. If recovery is successful the card application can be run. Otherwise the card is unusable.
</ABSTRACT>
<APPLICANTS>
<APPLICANT-NAME>
MONDEX INT LTD
</APPLICANT-NAME>
<APPLICANT-NAME>
MONDEX INTERNATIONAL LIMITED
</APPLICANT-NAME>
</APPLICANTS>
<INVENTORS>
<INVENTOR-NAME>
EVERETT DAVID B
</INVENTOR-NAME>
<INVENTOR-NAME>
JACKSON KEITH M
</INVENTOR-NAME>
<INVENTOR-NAME>
MILLER IAN
</INVENTOR-NAME>
<INVENTOR-NAME>
EVERETT, DAVID, B.
</INVENTOR-NAME>
<INVENTOR-NAME>
JACKSON, KEITH, M.
</INVENTOR-NAME>
<INVENTOR-NAME>
MILLER, IAN
</INVENTOR-NAME>
</INVENTORS>
<DESCRIPTION>
The invention relates to a method of utilisation of an
integrated circuit device and in particular to the writing of data to a non-volatile
memory forming part of an integrated circuit device.Non-volatile memory is memory which retains data without
electrical power being maintained. The invention is particularly concerned
with the writing of data to memory in transportable integrated circuit
devices which are used in conjunction with terminal devices with which
they are temporarily coupled for data input and output. An example of
such a transportable device is the integrated circuit card (ICC), otherwise
known as a "smart card".Smart cards are coupled by means of an interface to a
terminal device whereby power, clock signals, a reset signal and serial
data signals may be applied to the card. Generally the interface.
incorporates a set of electrical contacts for direct temporary electrical
connection. However, contactless interfaces employing electromagnetic
induction techniques for the application of power have been proposed. In
such an arrangement clock, reset and data signals may be coupled
electromagnetically or by infra-red or ultra-sonic techniques.
Transportable integrated circuit devices may be embodied in tokens of
other than card shape. Regardless of shape, such devices will be referred
to herein as integrated circuit cards (ICCs). A difficulty with ICCs is that
the writing of data to the ICC may be interfered with by disturbing the
interface during writing whereby transients or failure in power, reset or
clock signals may result in an erroneous write.WO 89/10618 describes a method of preventing the
corruption of data in a non-volatile memory should there be a power failure
during a write operation. To do this, information as to the steps to be
performed during the write operation is written to a double buffer prior to
commencement of the write operation. Next a flag is set to indicate that
the information in the double buffer is accurate. The write operation is 
then performed, and the flag cleared. Finally, the double buffer is
dynamically moved to at least two memory locations in the non-volatile
memory.WO 92/04716 describes a method and device for the
updating of memory. The invention is particularly concerned with possible
interruptions during the updating process and in particular that the
information to be updated is in a known state before or after the updating,
but is never in an indeterminate state. This is achieved by writing the new
value at another memory location and then checking
</DESCRIPTION>
<CLAIMS>
A method of utilisation of an integrated circuit device, the
device (1) having an interface (2) for temporary connection to a terminal

unit (4); a microprocessor (5); random access memory (6) and non-volatile
memory (7), the method of utilisation including a method of writing data to

said non-volatile memory (7) consisting in allocating a first region of the
non-volatile memory (7) for data to be written, allocating a second region of

non-volatile memory for write status information, performing a data write
operation to write data to said first region and writing information to said

second region signifying a valid data write if, and only if, the data write
operation is performed satisfactorily, said method being 
characterised by

further including the step of responding to a reset of the device (1) by
initially reading the said second region of the non-volatile memory (7) to

derive write status information therefrom and, if the write status information
indicates an incomplete write operation, enabling invalidation of the

integrated circuit device (1).
A method of utilisation of an integrated circuit device as
claimed in claim 1 including the step of instituting recovery of data to the

non-volatile memory (7), invalidation of the integrated circuit device (1)
being effected only on failure of said recovery.
A method of utilisation of an integrated circuit device as
cla
imed in claim 1 or claim 2 wherein the non-volatile memory (7) includes
an application program (AP) which controls the microprocessor (5) to run a

particular application under normal circumstances and invalidation of the
integrated circuit device is software invalidation whereby said application

program is by-passed.
A method of utilisation of an integrated circuit device as
claimed in claim 1 or claim 2 wherein invalidation of the integrated circuit

device (1) is effected by incapacitating the hardware of the device. 
A method of utilisation of an integrated circuit device as
claimed in any one of claims 1 to 4 wherein the non-volatile memory (7) is

divided into pages (8) and write operations are performed on only one
page at a time, the said first and second regions of memory being on

different pages.
A method of utilisation of an integrated circuit device as
claimed in any one of the preceding claims wherein the non-volatile

memory (7) is electrically erasable programmable read-only memory
(EEPROM).
A method of utilisation of an integrated circuit device as
claimed in any one of the preceding claims wherein said second region of

memory (7) is a status register, said status information is indicative of the
last satisfactorily performed stage of a multi-stage operation sequence and

said data recovery procedure is effective to recover the multi-stage
operation sequence from the stage at which it failed, as indicated by the

status register.
A method of utilisation of an integrated circuit device as
claimed in claim 7 wherein respective and separate regions of the non-volatile

memory (7) are allocated as:-

a. a sequence register which is said second region of
memory;
b. a data copy buffer;
c. a size register, and
d. an address register

and allocating a region of RAM or non-volatile memory as (e) a data
incremental buffer, the said first region of non-volatile memory (7) being

identified in size and address by data written in memory regions (c) and
(d), the said method of writing consisting in:-


1. ensuring that the buffer (e) contains a valid data
increment; 
2. placing a copy of data to be updated in the buffer (b);
3. incrementing the register (a);
4. incrementing the data at the first region of memory by
the amount in buffer (e) and writing the incremental

amount to the first region of memory; and
5. incrementing the sequence register (a).
A method of utilisation of an integrated circuit device as
claimed in claim 8 wherein the recovery procedure includes copying the

data from the data buffer (b) to said first region of memory.
A method of utilisation of an integrated circuit device as
claimed in any of claims 1 to 6 wherein said second region of memory (7)

is a flag region and said status information is a flag which is set if the said
write operation is verified as satisfactory and which is otherwise not set.
A method of utilisation of an integrated circuit device as
claimed in claim 10 wherein respective and separate regions of the non-volatile

memory (7) are allocated as:-

f. a write in progress flag register, which is said second
region of memory;
g. a workspace pointer register;
h. a size register; and
i. a data pointer register

and allocating a region of RAM or non-volatile memory as (j) a new data
pointer register, the said first region of non-volatile memory (7) being

identified in size and position by data written in memory regions (g) and (h),
the said method of writing consisting in:-


1. setting a workspace pointer in register (g) to the
address of non-volatile memory workspace sufficient to

hold a contiguous data set corresponding to a size set in
register (h);
2. copying to the workspace a copy of new data identified 
in address by the new data pointer at (j) and in size by

the size data at (h);
3. setting the write in progress flag at (f);
4. setting an address in data pointer register (i) to the
address of the workspace; and
5. clearing the write in progress flag in register (f).
A method of utilisation of an integrated circuit device as
claimed in claim 11 wherein the recovery procedure comprises the steps of

setting the address in data pointer register (i) to the address of the
workspace and clearing the write in progress flag in register (f).
A method of utilisation of an integrated circuit device as
claimed in claim 10 wherein respective and separate regions of the

non-volatile memory (7) are allocated as:-

k. a state flag register which is said second region of
memory;
I. a size register;
m. an address register; and
n. an update copy buffer

the said first region of non-volatile memory (7) being identified in size and
position by data written in registers (I) and (m), the said method of writing

consisting in:-

1. copying new data to be written into buffer (n);
2. setting the state flag in register (k);
3. writing said new data to be written to said first region
of non-volatile memory; and
4. clearing the state flag in register (k).
A method of utilisation of an integrated circuit device as
claimed in claim 13 wherein the recovery procedure comprises the steps of

copying the contents of the update copy buffer (n) to the said first region of
non-volatile memory identified by the contents of registers (I) and (m) and 

clearing the flag in register (k).
An integrated circuit device having an interface (2) for
temporary connection to a terminal unit (4); a microprocessor (5); random

access memory (6); and non-volatile memory (7), the non-volatile memory
including a program for controlling the microprocessor to effect the

methods of utilisation as claimed in any one of the preceding claims.
</CLAIMS>
</TEXT>
</DOC>
